{% extends 'base.html.twig' %}

{% block title %}Admin Dashboard - {{ parent() }}{% endblock %}

{% block body %}
<div class="card">
    <h2>Admin Dashboard</h2>
    
    {% if activeKitaYear %}
        <div class="info-box info-box-primary">
            <h3>Aktives Kita-Jahr: {{ activeKitaYear.yearString }}</h3>
            <p class="text-muted">
                {{ activeKitaYear.startDate|date('d.m.Y') }} - {{ activeKitaYear.endDate|date('d.m.Y') }}
            </p>
        </div>

        {% if previousYearsDeletable|length > 0 %}
            <div class="info-box info-box-warning">
                <h3 class="text-warning">
                    ğŸ—‘ï¸ Vorjahr kann gelÃ¶scht werden
                </h3>
                <p class="text-warning mb-md">
                    Der Kochplan fÃ¼r {{ activeKitaYear.yearString }} wurde generiert. 
                    {% if previousYearsDeletable|length == 1 %}
                        Das vorherige Jahr kann jetzt gelÃ¶scht werden:
                    {% else %}
                        Die vorherigen Jahre kÃ¶nnen jetzt gelÃ¶scht werden:
                    {% endif %}
                </p>
                <ul class="text-warning">
                    {% for year in previousYearsDeletable %}
                        <li><strong>{{ year.yearString }}</strong> ({{ year.startDate|date('d.m.Y') }} - {{ year.endDate|date('d.m.Y') }})</li>
                    {% endfor %}
                </ul>
                <a href="{{ path('admin_kita_year_index') }}" class="btn btn-warning">
                    Zu den Kita-Jahren â†’
                </a>
            </div>
        {% endif %}

        <div class="stats-grid">
            <div class="stat-card">
                <h4>Zugewiesene Kochdienste</h4>
                <div class="stat-number">{{ totalAssignments }}</div>
            </div>
        </div>

        <div class="btn-group mb-xl">
            <form method="post" action="{{ path('admin_generate_plan') }}" onsubmit="return confirm('MÃ¶chten Sie wirklich einen neuen Kochplan generieren? Alle bisherigen Zuweisungen werden gelÃ¶scht!');">
                <input type="hidden" name="_token" value="{{ csrf_token('generate-plan') }}">
                <button type="submit" class="btn btn-success">
                    Plan generieren
                </button>
            </form>
            
            {% if assignments|length > 0 %}
                <form method="post" action="{{ path('admin_delete_plan') }}" style="display: inline;" onsubmit="return confirm('âš ï¸ ACHTUNG: MÃ¶chten Sie wirklich den kompletten Kochplan fÃ¼r {{ activeKitaYear.yearString }} lÃ¶schen? Alle {{ totalAssignments }} Zuweisungen gehen verloren!');">
                    <input type="hidden" name="_token" value="{{ csrf_token('delete-plan') }}">
                    <button type="submit" class="btn btn-danger" style="background-color: #dc3545;">
                        ğŸ—‘ï¸ Plan lÃ¶schen
                    </button>
                </form>
            
                <form method="post" action="{{ path('admin_send_notifications') }}" style="display: inline;" onsubmit="return confirm('MÃ¶chten Sie wirklich E-Mail-Benachrichtigungen an alle Familien versenden?');">
                    <input type="hidden" name="_token" value="{{ csrf_token('send-notifications') }}">
                    <button type="submit" class="btn btn-success">
                        ğŸ“§ E-Mails versenden
                    </button>
                </form>
                
                <a href="{{ path('admin_calendar') }}" class="btn">
                    ğŸ“… Kalender
                </a>
                <a href="{{ path('admin_export_pdf') }}" class="btn" style="background-color: #6c757d; color: white;">
                    ğŸ“„ PDF exportieren
                </a>
            {% endif %}
        </div>

        {% if assignments|length > 0 %}
            <h3 style="margin: 2rem 0 1rem 0;">Statistik nach Familien</h3>
            
            {% if newFamilies|length > 0 %}
                <div class="alert alert-success" style="background-color: #d4edda; border: 1px solid #c3e6cb; border-left: 4px solid #28a745; padding: 0.75rem 1rem; border-radius: 4px; margin-bottom: 1rem;">
                    <strong>ğŸ†• Neue Familien in diesem Jahr:</strong> 
                    {{ newFamilies|length }} 
                    {% if newFamilies|length == 1 %}Familie{% else %}Familien{% endif %}
                    ({% for family in newFamilies %}{{ family.childrenNames }}{% if not loop.last %}, {% endif %}{% endfor %})
                </div>
            {% endif %}
            
            {% if familiesNotInPlan|length > 0 %}
                <div class="alert alert-warning" style="background-color: #fff3cd; border: 1px solid #ffc107; border-left: 4px solid #ff9800; padding: 0.75rem 1rem; border-radius: 4px; margin-bottom: 1rem;">
                    <strong>âš ï¸ Familien ohne Zuweisungen:</strong> 
                    {{ familiesNotInPlan|length }} 
                    {% if familiesNotInPlan|length == 1 %}Familie ist{% else %}Familien sind{% endif %}
                    nicht im Plan enthalten:
                    <div style="margin-top: 0.5rem;">
                        {% for party in familiesNotInPlan %}
                            <div style="display: inline-flex; align-items: center; gap: 0.5rem; margin: 0.25rem 0.5rem 0.25rem 0; background: #fff; padding: 0.25rem 0.75rem; border-radius: 4px; border: 1px solid #e0e0e0;">
                                <span>{{ party.childrenNames }}</span>
                                <form method="post" action="{{ path('admin_add_family_to_plan', {id: party.id}) }}" style="display: inline; margin: 0;" onsubmit="return confirm('{{ party.childrenNames }} in den bestehenden Plan aufnehmen? ZukÃ¼nftige Dienste werden von Ã¼berbelasteten Familien Ã¼bertragen.');">
                                    <input type="hidden" name="_token" value="{{ csrf_token('add-family-' ~ party.id) }}">
                                    <button type="submit" class="btn" style="background-color: #28a745; color: white; padding: 0.15rem 0.5rem; font-size: 0.75rem; border: none; cursor: pointer; border-radius: 3px;">
                                        â• In Plan aufnehmen
                                    </button>
                                </form>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
            
            <div class="alert alert-info" style="background-color: #e7f3ff; border: 1px solid #b3d9ff; padding: 0.75rem 1rem; border-radius: 4px; margin-bottom: 1rem;">
                <strong>â„¹ï¸ Hinweis:</strong> Zeigt die Anzahl zugewiesener Kochdienste pro Familie fÃ¼r das aktuelle Jahr. 
                Neue Familien sind mit einem ğŸ†•-Symbol markiert.
            </div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Familie</th>
                            <th>Erziehungsberechtigte</th>
                            <th style="text-align: center;">Status</th>
                            <th style="text-align: center;">Anzahl Dienste</th>
                            <th style="text-align: center;">Aktionen</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for stat in familyStats %}
                        <tr{% if stat.isNew %} style="background-color: #f0fff4;"{% endif %}>
                            <td>
                                <a href="{{ path('admin_party_show', {id: stat.party.id}) }}" style="text-decoration: none; color: #2c3e50;">
                                    {% if stat.isNew %}
                                        <span style="font-size: 1.1rem; margin-right: 0.25rem;">ğŸ†•</span>
                                    {% endif %}
                                    {{ stat.party.childrenNames }}
                                </a>
                            </td>
                            <td>{{ stat.party.parentNames|join(', ') }}</td>
                            <td style="text-align: center;">
                                {% if stat.party.isSingleParent %}
                                    <span style="background-color: #ffc107; color: #000; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">
                                        1 Person
                                    </span>
                                {% else %}
                                    <span style="background-color: #28a745; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">
                                        2 Personen
                                    </span>
                                {% endif %}
                            </td>
                            <td style="text-align: center;">
                                <span style="display: inline-block; background: {% if stat.isNew %}#28a745{% else %}#2c3e50{% endif %}; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-weight: bold;">
                                    {{ stat.count }}
                                </span>
                                {% if stat.isNew %}
                                    <div style="font-size: 0.7rem; color: #28a745; margin-top: 0.25rem;">NEU</div>
                                {% endif %}
                            </td>
                            <td style="text-align: center;">
                                <form method="post" action="{{ path('admin_remove_family_from_plan', {id: stat.party.id}) }}" style="display: inline; margin: 0;" onsubmit="return confirm('âš ï¸ {{ stat.party.childrenNames }} aus dem Plan entfernen? ZukÃ¼nftige Dienste werden an andere Familien umverteilt.');">
                                    <input type="hidden" name="_token" value="{{ csrf_token('remove-family-' ~ stat.party.id) }}">
                                    <button type="submit" style="background: none; border: none; color: #dc3545; cursor: pointer; font-size: 0.8rem; padding: 0.2rem 0.5rem; border-radius: 3px; border: 1px solid #dc3545;" title="Aus Plan entfernen">
                                        â– Entfernen
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <h3 style="margin: 2rem 0 1rem 0;">Zugewiesene Kochdienste (Zeitlich)</h3>
            <div class="table-wrapper">
                <table id="assignments-table">
                    <thead>
                        <tr>
                            <th>Datum</th>
                            <th>Wochentag</th>
                            <th>Familie</th>
                            <th>Typ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for assignment in assignments %}
                        {% set isToday = assignment.assignedDate|date('Y-m-d') == today|date('Y-m-d') %}
                        <tr class="assignment-row{% if isToday %} table-today-row{% endif %}" data-index="{{ loop.index }}"{% if loop.index > 20 %} style="display: none;"{% endif %}>
                            <td>{{ assignment.assignedDate|date('d.m.Y') }}{% if isToday %} <span style="font-size: 1.1rem;">ğŸ“…</span>{% endif %}</td>
                            <td>{{ assignment.assignedDate|date('l')|trans }}</td>
                            <td>{{ assignment.party.childrenNames }} <span style="color: #666; font-size: 0.9rem;">({{ assignment.party.parentNames|join(', ') }})</span></td>
                            <td>
                                {% if assignment.isManuallyAssigned %}
                                    <span style="color: #856404;">Manuell</span>
                                {% else %}
                                    <span style="color: #666;">Automatisch</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            {% if assignments|length > 20 %}
                <p style="text-align: center; margin-top: 1rem;">
                    <button id="toggle-assignments-btn" class="btn" style="background-color: #007bff; color: white;" onclick="toggleAssignments()">
                        <span id="btn-text-show">... und {{ assignments|length - 20 }} weitere Zuweisungen anzeigen</span>
                        <span id="btn-text-hide" style="display: none;">Weniger anzeigen</span>
                    </button>
                </p>
                
                <script>
                let isExpanded = false;
                
                function toggleAssignments() {
                    const allRows = document.querySelectorAll('.assignment-row[data-index]');
                    const showText = document.getElementById('btn-text-show');
                    const hideText = document.getElementById('btn-text-hide');
                    const btn = document.getElementById('toggle-assignments-btn');
                    
                    if (isExpanded) {
                        // Verstecke zusÃ¤tzliche Zeilen (alles Ã¼ber Index 20)
                        allRows.forEach(row => {
                            const index = parseInt(row.getAttribute('data-index'));
                            if (index > 20) {
                                row.style.display = 'none';
                            }
                        });
                        showText.style.display = 'inline';
                        hideText.style.display = 'none';
                        btn.style.backgroundColor = '#007bff';
                        isExpanded = false;
                        
                        // Scrolle zum Anfang der Tabelle
                        document.getElementById('assignments-table').scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'start' 
                        });
                    } else {
                        // Zeige alle Zeilen
                        allRows.forEach(row => {
                            row.style.display = 'table-row';
                        });
                        showText.style.display = 'none';
                        hideText.style.display = 'inline';
                        btn.style.backgroundColor = '#6c757d';
                        isExpanded = true;
                    }
                }
                </script>
            {% endif %}
        {% else %}
            <div style="text-align: center; padding: 3rem; background-color: #fff3cd; border-radius: 4px;">
                <p style="margin: 0; color: #856404;">
                    â„¹ï¸ Noch keine Kochdienste zugewiesen. Klicken Sie auf "Kochplan neu generieren".
                </p>
            </div>
        {% endif %}
    {% else %}
        <div style="text-align: center; padding: 3rem; background-color: #f8d7da; border-radius: 4px;">
            <p style="margin: 0; color: #721c24;">
                âš ï¸ Kein aktives Kita-Jahr gefunden. Bitte erstellen Sie zuerst ein Kita-Jahr.
            </p>
        </div>
    {% endif %}
</div>

<div class="card">
    <h3>Schnellzugriff</h3>
    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
        <a href="{{ path('admin_party_index') }}" class="btn">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Familien verwalten</a>
        <a href="{{ path('admin_kita_year_index') }}" class="btn">ğŸ—“ï¸ Kita-Jahre verwalten</a>
        <a href="{{ path('admin_holiday_index') }}" class="btn">ğŸ‰ Feiertage verwalten</a>
        <a href="{{ path('admin_vacation_index') }}" class="btn">ğŸ–ï¸ Ferienzeiten verwalten</a>
    </div>
</div>
{% endblock %}
